<html>

<link rel="stylesheet" type="text/css" href="../../lib/css/themes/jquery-ui/redmond/jquery-ui.min.css"/>
<script type="text/javascript" src="../../lib/js/jquery-1.11.1.min.js"></script>
<script type="text/javascript" src="../../socket.io/socket.io.js"></script>
<script type="text/javascript" src="../../lib/js/jquery-ui-1.10.3.full.min.js"></script>

<link rel="stylesheet" type="text/css" href="../../css/adapter.css"/>
<script type="text/javascript" src="../../js/translate.js"></script>
<script type="text/javascript" src="../../js/adapter-settings.js"></script>

<style>
    .number {
        width: 70px
    }
    .table-values th {
        background: #686868;
        color: #FFF;
        font-weight: bold;
    }
    .table-values tr:nth-child(even) {
        background: #d0d0d0;
    }
</style>

<script type="text/javascript">
    systemDictionary = {
        "Proxy adapter settings": {
            "de": "Proxy Adapter Einstellungen",
            "ru": "Настройки Proxy драйвера"
        },
        "Extend WEB adapter:":    {"en": "Extend WEB adapter:",     "de": "Erweitere WEB Adapter:",  "ru": "Подключить к WEB драйверу:"},
        "all":                    {"en": "all",                     "de": "alle",                    "ru": "все"}
    };

    // the function loadSettings has to exist ...
    function load(settings, onChange) {
        if (!settings) return;

        $('.value').each(function () {
            var key = $(this).attr('id');
            var $key = $('#' + key + '.value');
            if ($key.attr('type') === 'checkbox') {
                $key.prop('checked', settings[key]).change(function() {
                    onChange();
                });
            } else {
                $('#' + key + '.value').val(settings[key]).change(function() {
                    onChange();
                }).keyup(function() {
                    onChange();
                });
            }
        });

        getExtendableInstances(function (result) {
            if (result) {
                var text = '';
                for (var r = 0; r < result.length; r++) {
                    var name = result[r]._id.substring('system.adapter.'.length);
                    text += '<option value="' + name + '" ' + (settings.webInstance === name ? 'selected' : '') + '>' + name + '</option>';
                }
                $('#webInstance').append(text);
            }
        });

        onChange(false);
        values2table(settings.rules, onChange);
    }

    function table2values() {
        var names = [];
        $('.table-values th').each(function () {
            var name = $(this).data('name');
            if (name) {
                names.push(name);
            } else {
                names.push('___ignore___');
            }
        });
        var values = [];
        var j = 0;
        $('.table-lines tr').each(function () {
            values[j] = {};
            $(this).find('td').each(function () {
                var $input = $(this).find('input');
                if ($input.length) {
                    var name = $input.data('name');
                    if ($input.attr('type') === 'checkbox') {
                        values[j][name] = $input.prop('checked');
                    } else {
                        values[j][name] = $input.val();
                    }
                }
            });
            j++;
        });

        return values;
    }

    function values2table(values, onChange) {
        var names = [];
        var $add = $('.table-button-add');

        if (!$add.data('inited')) {
            $add.data('inited', true);

            $add.button({
                icons: {primary: 'ui-icon-plus'},
                text: false
            })
                .css({width: '1em', height: '1em'})
                .click(function () {
                    var values = $('.table-values').data('values');
                    var obj = {};
                    for (var i = 0; i < names.length; i++) {
                        if (!names[i]) continue;
                        obj[names[i].name] = names[i].def;
                    }
                    values.push(obj);
                    setTimeout(function () {
                        values2table(values, onChange);
                    }, 100);
                });
        }


        if (values) {
            var buttons = [];
            $('.table-values').data('values', values);

            $('.table-values th').each(function () {
                var name = $(this).data('name');
                if (name) {
                    var obj = {
                        name:    name,
                        type:    $(this).data('type') || 'text',
                        def:     $(this).data('default')
                    };
                    if (obj.type === 'checkbox') {
                        if (obj.def === 'false') obj.def = false;
                        if (obj.def === 'true')  obj.def = true;
                        obj.def = !!obj.def;
                    } else {
                        obj.def = obj.def || '';
                    }
                    names.push(obj);
                } else {
                    names.push(null);
                }
                name = $(this).data('buttons');
                if (name) {
                    var bs = name.split(' ');
                    buttons.push(bs);
                } else {
                    buttons.push(null);
                }
            });

            var text = '';
            for (var v = 0; v < values.length; v++) {
                text += '<tr>';

                for (var i = 0; i < names.length; i++) {
                    text += '<td>';
                    if (names[i]) {
                        if (names[i].type === 'checkbox') {
                            text += '<input class="values-input" type="checkbox" data-index="' + v + '" data-name="' + names[i].name + '" ' + (values[v][names[i].name] ? 'checked' : '') + '" data-old-value="' + values[v][names[i].name] + '"/>';
                        } else {
                            text += '<input class="values-input" style="width: 100%" type="' + names[i].type + '" data-index="' + v + '" data-name="' + names[i].name + '" value="' + values[v][names[i].name] + '"  data-old-value="' + values[v][names[i].name] + '"/>';
                        }
                    }

                    if (buttons[i]) {
                        for (var b = 0; b < buttons[i].length; b++) {
                            text += '<button data-index="' + v + '" data-command="' + buttons[i][b] + '" class="values-buttons"></button>';
                        }
                    }
                    text += '</td>';
                }

                text += '</tr>';
            }$('.table-lines').html(text);

            $('.table-lines .values-buttons').each(function () {
                var command = $(this).data('command');
                if (command === 'delete') {
                    $(this).button({
                        icons: {primary: 'ui-icon-trash'},
                        text: false
                    })
                    .css({width: '1em', height: '1em'})
                    .click(function () {
                        var id = $(this).data('index');
                        values.splice(id, 1);
                        setTimeout(function () {
                            values2table(values, onChange);
                        }, 100);
                    });
                }
            });
            $('.table-lines .values-input').change(function () {
                if ($(this).attr('type') === 'checkbox') {
                    if ($(this).prop('checked').toString() !== $(this).data('old-value')) onChange();
                    values[$(this).data('index')][$(this).data('name')] = $(this).prop('checked');
                } else {
                    if ($(this).val() !== $(this).data('old-value')) onChange();
                    values[$(this).data('index')][$(this).data('name')] = $(this).val();

                }
            }).keyup(function () {
                $(this).trigger('change');
            });
        }
    }
    // ... and the function save has to exist.
    // you have to make sure the callback is called with the settings object as first param!
    function save(callback) {
        // example: select elements with class=value and build settings object
        var obj = {};
        $('.value').each(function () {
            var $this = $(this);
            if ($this.attr('type') === 'checkbox') {
                obj[$this.attr('id')] = $this.prop('checked');
            } else {
                obj[$this.attr('id')] = $this.val();
            }
        });
        obj.rules = table2values();

        callback(obj);
    }
</script>

<div id="adapter-container">

    <table><tr><td><img src="proxy.png"></td><td><h3 class="translate">Proxy adapter settings</h3></td></tr></table>

    <table style="width: 100%;">
        <tr>
            <td style="width: 200px;"><label for="webInstance" class="translate">Extend WEB adapter:</label></td>
            <td><select class="value" id="webInstance">
                    <option value="*" class="translate">all</option>
                </select>
            </td>
        </tr>
        <tr>
            <td colspan="2">&nbsp;
            </td>
        </tr>
        <tr>
            <td colspan="2">
                <button class="table-button-add" style="margin-left: 10px"></button>
                <table class="table-values" style="width: 100%">
                    <thead>
                    <tr>
                        <th data-name="regex" style="width: 30%">Shortcut</th>
                        <th data-name="url">URL</th>
                        <th data-buttons="delete" style="width: 32px"></th>
                    </tr>
                    </thead>
                    <tbody class="table-lines">

                    </tbody>
                </table>
            </td>

    </table>
</div>
</html>
